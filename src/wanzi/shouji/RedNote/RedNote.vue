<template>
  <!-- é¦–é¡µ -->
  <div
    v-show="
      !sharedState.RedNote.activePost &&
      sharedState.phone.activeApp === 'RedNote' &&
      sharedState.RedNote.activeTab === 'home'
    "
    class="rednote-homepage"
  >
    <div class="rednote-homepage-top">
      <div
        class="user_avatar"
        style="
          width: 35px;
          height: 35px;
          border-radius: 50%;
          background-size: cover;
          background-position: top center;
          background-repeat: no-repeat;
          background-color: black;
          aspect-ratio: 1;
          min-width: 35px;
        "
        @click="sharedState.phone.activeApp = 'QQ'"
      ></div>
      <div style="display: flex; margin-bottom: -5px; flex: 1; justify-content: space-evenly">
        <div style="font-size: 16px; color: rgb(100, 100, 100) !important; white-space: nowrap !important">å…³æ³¨</div>
        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
            color: black !important;
            white-space: nowrap !important;
          "
        >
          <div>å‘ç°</div>
          <div style="width: 3rem; height: 4px; background-color: #e73f4c; border-radius: 10px"></div>
        </div>
        <div style="font-size: 16px; color: rgb(100, 100, 100) !important; white-space: nowrap !important">åŒåŸ</div>
      </div>

      <div
        style="
          width: 35px;
          height: 35px;
          border-radius: 50%;
          aspect-ratio: 1;
          min-width: 35px;
          display: flex;
          align-items: center;
          justify-content: center;
        "
      >
        <svg viewBox="0 0 1024 1024" width="20" height="20" style="margin-top: -5px">
          <path
            d="M704.448 648.768L956.48 900.736l-55.744 55.68L648.64 704.384a393.856 393.856 0 1 1 55.808-55.68z m-82.24-26.56a315.072 315.072 0 1 0-437.76-453.248 315.072 315.072 0 0 0 437.76 453.248z"
            p-id="16026"
            fill="#303030"
          ></path>
        </svg>
      </div>
    </div>
    <div class="rednote-homepage-content">
      <div style="display: flex; flex-direction: column; width: 100%">
        <div
          v-for="value of sharedState.RedNote.post.filter((_, index) => index % 2 === 0)"
          class="rednote-homepage-post"
          @click="
            sharedState.RedNote.activePost = value.id;
            console.log(value.id);
          "
        >
          <div
            class="rednote-homepage-post-img"
            :style="`background-color:${value.imgColor};color:${value.textColor};`"
          >
            {{ value.img }}
          </div>
          <div class="rednote-homepage-post-info">
            <div class="rednote-homepage-post-title">{{ value.title }}</div>
            <div class="rednote-homepage-post-author">
              <div
                :style="`background-image: url('${value.head}');
                  width: 25px;
                  height: 25px;
                  border-radius: 50%;
                  background-size: cover;
                  background-position: top center;
                  background-repeat: no-repeat;
                  background-color: black;
                  aspect-ratio: 1;
                  min-width: 25px;`"
              ></div>
              <div
                style="
                  color: rgb(100, 100, 100);
                  font-size: 14px;
                  flex: 1;
                  text-overflow: ellipsis;
                  overflow: hidden;
                  white-space: nowrap;
                "
              >
                {{ value.sender }}
              </div>
              <svg viewBox="0 0 1024 1024" width="20" height="20">
                <path
                  d="M171.712 571.648l0.352 0.32 287.904 252.8a64 64 0 0 0 82.912 1.344l296.832-244.544a215.584 215.584 0 1 0-301.824-300.576L512 316.672l-25.888-35.616a215.584 215.584 0 1 0-314.4 290.624zM32 407.584a279.584 279.584 0 0 1 480-194.944 279.584 279.584 0 0 1 480 194.944 278.144 278.144 0 0 1-113.024 224.512l-295.36 243.392a128 128 0 0 1-165.888-2.592L129.984 620.16A278.976 278.976 0 0 1 32 407.584z"
                  fill="#646464"
                  p-id="4875"
                ></path>
              </svg>
              <div style="color: #646464; font-size: 12px">{{ value.like }}</div>
            </div>
          </div>
        </div>
      </div>
      <div style="display: flex; flex-direction: column; width: 100%">
        <div
          v-for="value of sharedState.RedNote.post.filter((_, index) => index % 2 === 1)"
          class="rednote-homepage-post"
          @click="
            sharedState.RedNote.activePost = value.id;
            console.log(value.id);
          "
        >
          <div class="rednote-homepage-post-img" :style="`background-color:${value.imgColor}`">{{ value.img }}</div>
          <div class="rednote-homepage-post-info">
            <div class="rednote-homepage-post-title">{{ value.title }}</div>
            <div class="rednote-homepage-post-author">
              <div
                :style="`background-image: url('${value.head}');
                  width: 25px;
                  height: 25px;
                  border-radius: 50%;
                  background-size: cover;
                  background-position: top center;
                  background-repeat: no-repeat;
                  background-color: black;
                  aspect-ratio: 1;
                  min-width: 25px;`"
              ></div>
              <div
                style="
                  color: rgb(100, 100, 100);
                  font-size: 14px;
                  flex: 1;
                  text-overflow: ellipsis;
                  overflow: hidden;
                  white-space: nowrap;
                "
              >
                {{ value.sender }}
              </div>
              <svg viewBox="0 0 1024 1024" width="20" height="20">
                <path
                  d="M171.712 571.648l0.352 0.32 287.904 252.8a64 64 0 0 0 82.912 1.344l296.832-244.544a215.584 215.584 0 1 0-301.824-300.576L512 316.672l-25.888-35.616a215.584 215.584 0 1 0-314.4 290.624zM32 407.584a279.584 279.584 0 0 1 480-194.944 279.584 279.584 0 0 1 480 194.944 278.144 278.144 0 0 1-113.024 224.512l-295.36 243.392a128 128 0 0 1-165.888-2.592L129.984 620.16A278.976 278.976 0 0 1 32 407.584z"
                  fill="#646464"
                  p-id="4875"
                ></path>
              </svg>
              <div style="color: #646464; font-size: 12px">{{ value.like }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="rednote-homepage-bottom">
      <div
        class="rednote-homepage-bottom-button"
        style="color: black; font-size: 18px"
        @click="sharedState.RedNote.activeTab = 'home'"
      >
        é¦–é¡µ
      </div>
      <div class="rednote-homepage-bottom-button" @click="sharedState.RedNote.activeTab = 'market'">å¸‚é›†</div>
      <div
        style="width: 3rem; height: 40px; background-color: #ea3e4a; border-radius: 9px; position: relative"
        @click="sharedState.phone.activeApp = 'QQ'"
      >
        <div
          style="
            width: 50%;
            background-color: white;
            height: 4px;
            position: absolute;
            border-radius: 5px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          "
        ></div>
        <div
          style="
            width: 50%;
            background-color: white;
            height: 4px;
            position: absolute;
            border-radius: 5px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
          "
        ></div>
      </div>
      <div class="rednote-homepage-bottom-button">æ¶ˆæ¯</div>
      <div class="rednote-homepage-bottom-button">æˆ‘çš„</div>
    </div>
  </div>

  <!-- å¸–å­è¯¦æƒ…é¡µé¢ -->
  <transition name="slide-fade">
    <div
      v-show="sharedState.RedNote.activePost && sharedState.phone.activeApp === 'RedNote'"
      class="rednote-postpage-list"
      style="width: 100%; height: 100%"
    >
      <post v-for="value of sharedState.RedNote.post" :post-content="value"></post>
    </div>
  </transition>

  <!-- å¸‚é›†é¡µé¢ -->
  <div
    v-show="sharedState.phone.activeApp === 'RedNote' && sharedState.RedNote.activeTab === 'market'"
    class="rednote-market"
  >
    <div class="rednote-market-top">
      <div
        class="user_avatar"
        style="
          width: 35px;
          height: 35px;
          border-radius: 50%;
          background-size: cover;
          background-position: top center;
          background-repeat: no-repeat;
          background-color: black;
          aspect-ratio: 1;
          min-width: 35px;
        "
        @click="sharedState.phone.activeApp = 'QQ'"
      ></div>
      <div class="market-search">
        <div class="search-box">
          <svg viewBox="0 0 1024 1024" width="16" height="16">
            <path
              d="M704.448 648.768L956.48 900.736l-55.744 55.68L648.64 704.384a393.856 393.856 0 1 1 55.808-55.68z m-82.24-26.56a315.072 315.072 0 1 0-437.76-453.248 315.072 315.072 0 0 0 437.76 453.248z"
              p-id="16026"
              fill="#646464"
            ></path>
          </svg>
          <input type="text" placeholder="æœç´¢å•†å“" />
        </div>
      </div>
      <div class="market-cart" @click="sharedState.RedNote.activeTab = 'cart'">
        <svg viewBox="0 0 1024 1024" width="20" height="20">
          <path
            d="M922.9 701.9H327.4l29.9-60.9 496.8-.9c16.8 0 31.2-12 34.2-28.6l68.8-385.1c1.8-10.1-.9-20.3-7.5-28.4-6.6-8.1-16.5-12.9-26.7-12.9l-584.8-.9-12.6-61.2c-3.6-17.6-19.9-30.2-37.9-30.2L89.1 96.8c-19.9 0-36 16.1-36 36s16.1 36 36 36h128.9l155.3 756.7c3.6 17.6 19.9 30.2 37.9 30.2H901c19.9 0 36-16.1 36-36s-16.1-36.1-36-36.1zM384.8 508.9v-.1l-23-107.8h515.4l-56.6 316.8-436.8.9z"
            fill="#646464"
          ></path>
          <path d="M377.9 872.9m-48 0a48 48 0 1 0 96 0 48 48 0 1 0-96 0Z" fill="#646464"></path>
          <path d="M765.9 872.9m-48 0a48 48 0 1 0 96 0 48 48 0 1 0-96 0Z" fill="#646464"></path>
        </svg>
      </div>
    </div>

    <div class="market-categories">
      <div
        v-for="category in marketCategories"
        :key="category.id"
        class="category-item"
        :class="{ active: sharedState.RedNote.marketCategory === category.id }"
        @click="sharedState.RedNote.marketCategory = category.id"
      >
        {{ category.name }}
      </div>
    </div>

    <div class="market-content">
      <div class="product-grid">
        <div
          v-for="product in filteredProducts"
          :key="product.id"
          class="product-card"
          @click="viewProductDetail(product)"
        >
          <div class="product-image" :style="`background-image: url('${product.image}')`"></div>
          <div class="product-info">
            <div class="product-title">{{ product.title }}</div>
            <div class="product-price">{{ product.price }}</div>
            <div class="product-seller">
              <div class="seller-avatar"></div>
              <span class="seller-name">{{ product.seller }}</span>
            </div>
            <div class="product-stats">
              <span>æƒ³è¦ {{ product.wants }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="rednote-homepage-bottom">
      <div class="rednote-homepage-bottom-button" @click="sharedState.RedNote.activeTab = 'home'">é¦–é¡µ</div>
      <div class="rednote-homepage-bottom-button" style="color: black; font-size: 18px">å¸‚é›†</div>
      <div
        style="width: 3rem; height: 40px; background-color: #ea3e4a; border-radius: 9px; position: relative"
        @click="sharedState.phone.activeApp = 'QQ'"
      >
        <div
          style="
            width: 50%;
            background-color: white;
            height: 4px;
            position: absolute;
            border-radius: 5px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          "
        ></div>
        <div
          style="
            width: 50%;
            background-color: white;
            height: 4px;
            position: absolute;
            border-radius: 5px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
          "
        ></div>
      </div>
      <div class="rednote-homepage-bottom-button">æ¶ˆæ¯</div>
      <div class="rednote-homepage-bottom-button">æˆ‘çš„</div>
    </div>
  </div>

  <!-- å•†å“è¯¦æƒ…é¡µé¢ -->
  <div v-show="sharedState.RedNote.activeProduct && sharedState.phone.activeApp === 'RedNote'" class="product-detail">
    <div class="detail-header">
      <div class="back-button" @click="sharedState.RedNote.activeProduct = null">
        <svg viewBox="0 0 1024 1024" width="20" height="20">
          <path d="M724 218.3L481.9 461.5l240.8 240.8-47.5 47.5L386.9 461.5 676.5 170.8z" fill="#000"></path>
        </svg>
      </div>
      <div class="header-title">å•†å“è¯¦æƒ…</div>
      <div class="header-actions">
        <svg viewBox="0 0 1024 1024" width="20" height="20">
          <path
            d="M768 810.6c0 47.1-38.1 85.3-85.3 85.3s-85.3-38.1-85.3-85.3 38.1-85.3 85.3-85.3 85.3 38.1 85.3 85.3z m-384 0c0 47.1-38.1 85.3-85.3 85.3s-85.3-38.1-85.3-85.3 38.1-85.3 85.3-85.3 85.3 38.1 85.3 85.3zM170.7 810.6c0 47.1-38.1 85.3-85.3 85.3S0 857.7 0 810.6s38.1-85.3 85.3-85.3 85.4 38.2 85.4 85.3z"
            fill="#000"
          ></path>
        </svg>
      </div>
    </div>

    <div v-if="sharedState.RedNote.activeProduct" class="detail-content">
      <div class="product-images">
        <div class="main-image" :style="`background-image: url('${sharedState.RedNote.activeProduct.image}')`"></div>
      </div>

      <div class="product-detail-info">
        <div class="detail-price">{{ sharedState.RedNote.activeProduct.price }}</div>
        <div class="detail-title">{{ sharedState.RedNote.activeProduct.title }}</div>
        <div class="detail-desc">{{ sharedState.RedNote.activeProduct.description }}</div>

        <div class="seller-info">
          <div class="seller-avatar"></div>
          <div class="seller-details">
            <div class="seller-name">{{ sharedState.RedNote.activeProduct.seller }}</div>
            <div class="seller-rating">â­ 4.9 (128è¯„ä»·)</div>
          </div>
          <button class="follow-btn" @click="followSeller">å…³æ³¨</button>
        </div>

        <div class="product-actions">
          <button class="cart-btn" @click="addToCart">åŠ å…¥è´­ç‰©è½¦</button>
          <button class="buy-btn" @click="buyNow">ç«‹å³è´­ä¹°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è´­ç‰©è½¦é¡µé¢ -->
  <div v-show="sharedState.RedNote.activeTab === 'cart' && sharedState.phone.activeApp === 'RedNote'" class="cart-page">
    <div class="cart-header">
      <div class="back-button" @click="sharedState.RedNote.activeTab = 'market'">
        <svg viewBox="0 0 1024 1024" width="20" height="20">
          <path d="M724 218.3L481.9 461.5l240.8 240.8-47.5 47.5L386.9 461.5 676.5 170.8z" fill="#000"></path>
        </svg>
      </div>
      <div class="header-title">è´­ç‰©è½¦</div>
      <div class="header-actions" @click="toggleCartManagement">{{ isManagingCart ? 'å®Œæˆ' : 'ç®¡ç†' }}</div>
    </div>

    <div class="cart-content">
      <div v-if="sharedState.RedNote.cart.length === 0" class="empty-cart">
        <div class="empty-icon">ğŸ›’</div>
        <div class="empty-text">è´­ç‰©è½¦è¿˜æ˜¯ç©ºçš„</div>
        <button class="go-shopping" @click="sharedState.RedNote.activeTab = 'market'">å»é€›é€›</button>
      </div>

      <div v-else class="cart-items">
        <!-- è´­ç‰©è½¦å•†å“åˆ—è¡¨ -->
        <div v-for="(item, index) in sharedState.RedNote.cart" :key="item.id" class="cart-item">
          <div v-if="isManagingCart" class="item-select">
            <input v-model="item.selected" type="checkbox" />
          </div>
          <div class="item-image" :style="`background-image: url('${item.image}')`"></div>
          <div class="item-info">
            <div class="item-title">{{ item.title }}</div>
            <div class="item-price">{{ item.price }}</div>
            <div class="item-seller">{{ item.seller }}</div>
            <div v-if="isManagingCart" class="item-actions">
              <button class="delete-btn" @click="removeFromCart(index)">åˆ é™¤</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div v-if="sharedState.RedNote.cart.length > 0 && isManagingCart" class="cart-management">
      <button class="select-all-btn" @click="selectAllItems">
        {{ isAllSelected ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰' }}
      </button>
      <button class="buy-selected-btn" @click="buySelectedItems">è´­ä¹°é€‰ä¸­</button>
      <button class="delete-selected-btn" @click="deleteSelectedItems">åˆ é™¤é€‰ä¸­</button>
    </div>

    <div class="rednote-homepage-bottom">
      <div class="rednote-homepage-bottom-button" @click="sharedState.RedNote.activeTab = 'home'">é¦–é¡µ</div>
      <div class="rednote-homepage-bottom-button" @click="sharedState.RedNote.activeTab = 'market'">å¸‚é›†</div>
      <div
        style="width: 3rem; height: 40px; background-color: #ea3e4a; border-radius: 9px; position: relative"
        @click="sharedState.phone.activeApp = 'QQ'"
      >
        <div
          style="
            width: 50%;
            background-color: white;
            height: 4px;
            position: absolute;
            border-radius: 5px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          "
        ></div>
        <div
          style="
            width: 50%;
            background-color: white;
            height: 4px;
            position: absolute;
            border-radius: 5px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
          "
        ></div>
      </div>
      <div class="rednote-homepage-bottom-button">æ¶ˆæ¯</div>
      <div class="rednote-homepage-bottom-button">æˆ‘çš„</div>
    </div>
  </div>
</template>

<script setup>
import { computed, ref } from 'vue';
import { sharedState } from '../shared-state';
import post from './post.vue';

// åˆå§‹åŒ–å¸‚é›†ç›¸å…³çŠ¶æ€
if (!sharedState.RedNote.activeTab) {
  sharedState.RedNote.activeTab = 'home';
}
if (!sharedState.RedNote.marketCategory) {
  sharedState.RedNote.marketCategory = 'all';
}
if (!sharedState.RedNote.cart) {
  sharedState.RedNote.cart = [];
}
if (!sharedState.RedNote.products) {
  sharedState.RedNote.products = [];
}

// è´­ç‰©è½¦ç®¡ç†çŠ¶æ€
const isManagingCart = ref(false);

// å•†å“åˆ†ç±»
const marketCategories = [
  { id: 'all', name: 'å…¨éƒ¨' },
  { id: 'cultivation', name: 'ä¿®ç‚¼èµ„æº' },
  { id: 'weapon', name: 'æ³•å™¨æ³•å®' },
  { id: 'potion', name: 'ä¸¹è¯çµè‰' },
  { id: 'artifact', name: 'å¤å®å¥‡ç‰©' },
  { id: 'fashion', name: 'ä»™è¡£éœ“è£³' },
];

// è®¡ç®—å±æ€§ï¼šæ ¹æ®åˆ†ç±»ç­›é€‰å•†å“
const filteredProducts = computed(() => {
  const products = sharedState.RedNote.products || [];
  if (sharedState.RedNote.marketCategory === 'all') return products;
  return products.filter(product => product.category === sharedState.RedNote.marketCategory);
});

// è®¡ç®—å±æ€§ï¼šæ£€æŸ¥æ˜¯å¦å…¨é€‰
const isAllSelected = computed(() => {
  if (sharedState.RedNote.cart.length === 0) return false;
  return sharedState.RedNote.cart.every(item => item.selected);
});

// æŸ¥çœ‹å•†å“è¯¦æƒ…
const viewProductDetail = product => {
  sharedState.RedNote.activeProduct = product;
};

// å…³æ³¨å•†å®¶
const followSeller = () => {
  if (sharedState.RedNote.activeProduct) {
    const seller = sharedState.RedNote.activeProduct.seller;
    alert(`å·²å…³æ³¨å•†å®¶ï¼š${seller}`);
  }
};

// åŠ å…¥è´­ç‰©è½¦
const addToCart = () => {
  if (sharedState.RedNote.activeProduct) {
    const product = { ...sharedState.RedNote.activeProduct };
    // æ·»åŠ é€‰ä¸­çŠ¶æ€ç”¨äºç®¡ç†
    product.selected = false;

    // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨è´­ç‰©è½¦ä¸­
    const existingIndex = sharedState.RedNote.cart.findIndex(item => item.id === product.id);
    if (existingIndex === -1) {
      sharedState.RedNote.cart.push(product);

      // ç”ŸæˆåŠ å…¥è´­ç‰©è½¦æ¶ˆæ¯
      // const cartMessage = `å°†${product.seller}çš„${product.title}åŠ å…¥è´­ç‰©è½¦ï¼Œä»·æ ¼${product.price}`;

      // åˆ‡æ¢åˆ°QQåº”ç”¨
      // sharedState.phone.activeApp = 'QQ';

      // è®¾ç½®åˆ°è¾“å…¥æ¡†
      // if (sharedState.phone.sendModel == 'å°¾é™„') {
      //   const old_content = $('#send_textarea').val().trim();
      //   const new_content = old_content + cartMessage;
      //   $('#send_textarea')
      //     .val(new_content.trim() || '')[0]
      //     .dispatchEvent(new Event('input', { bubbles: true }));
      // } else {
      //   triggerSlash(`/send ${cartMessage.trim()}|/trigger`);
      // }

      // æ¸…ç©ºç¼“å­˜æ¶ˆæ¯
      // sharedState.QQ.cacheMsg = [];
    } else {
      alert(`${product.title} å·²åœ¨è´­ç‰©è½¦ä¸­`);
    }
  }
};

// ç«‹å³è´­ä¹°
const buyNow = () => {
  if (sharedState.RedNote.activeProduct) {
    const product = sharedState.RedNote.activeProduct;
    const purchaseMessage = `è´­ä¹°äº†${product.seller}çš„å•†å“(${product.title}),å•†å“ID(${product.id})ï¼ŒèŠ±äº†${product.price}`;

    // åˆ‡æ¢åˆ°QQåº”ç”¨
    sharedState.phone.activeApp = 'QQ';

    // ç”Ÿæˆè´­ä¹°æ¶ˆæ¯å¹¶è®¾ç½®åˆ°è¾“å…¥æ¡†
    if (sharedState.phone.sendModel == 'å°¾é™„') {
      const old_content = $('#send_textarea').val().trim();
      const new_content = old_content + purchaseMessage;
      $('#send_textarea')
        .val(new_content.trim() || '')[0]
        .dispatchEvent(new Event('input', { bubbles: true }));
    } else {
      triggerSlash(`/send ${purchaseMessage.trim()}|/trigger`);
    }

    // æ¸…ç©ºç¼“å­˜æ¶ˆæ¯
    sharedState.QQ.cacheMsg = [];
  }
};

// åˆ‡æ¢è´­ç‰©è½¦ç®¡ç†çŠ¶æ€
const toggleCartManagement = () => {
  isManagingCart.value = !isManagingCart.value;
};

// ä»è´­ç‰©è½¦ç§»é™¤å•†å“
const removeFromCart = index => {
  sharedState.RedNote.cart.splice(index, 1);
};

// å…¨é€‰/å–æ¶ˆå…¨é€‰
const selectAllItems = () => {
  const newSelectedState = !isAllSelected.value;
  sharedState.RedNote.cart.forEach(item => {
    item.selected = newSelectedState;
  });
};

// è´­ä¹°é€‰ä¸­å•†å“
const buySelectedItems = () => {
  const selectedItems = sharedState.RedNote.cart.filter(item => item.selected);
  if (selectedItems.length === 0) {
    alert('è¯·é€‰æ‹©è¦è´­ä¹°çš„å•†å“');
    return;
  }

  let totalPrice = 0;
  let purchaseMessage = '';

  selectedItems.forEach((item, index) => {
    if (index > 0) purchaseMessage += 'ã€';
    purchaseMessage += `è´­ä¹°äº†${item.seller}çš„å•†å“(${item.title}),å•†å“ID(${item.id})`;
    totalPrice += parseFloat(item.price.replace('çµçŸ³', ''));
  });

  purchaseMessage += `ï¼Œæ€»å…±èŠ±è´¹${totalPrice}çµçŸ³`;

  // åˆ‡æ¢åˆ°QQåº”ç”¨
  sharedState.phone.activeApp = 'QQ';

  // è®¾ç½®åˆ°è¾“å…¥æ¡†
  if (sharedState.phone.sendModel == 'å°¾é™„') {
    const old_content = $('#send_textarea').val().trim();
    const new_content = old_content + purchaseMessage;
    $('#send_textarea')
      .val(new_content.trim() || '')[0]
      .dispatchEvent(new Event('input', { bubbles: true }));
  } else {
    triggerSlash(`/send ${purchaseMessage.trim()}|/trigger`);
  }

  // ä»è´­ç‰©è½¦ç§»é™¤å·²è´­ä¹°çš„å•†å“
  sharedState.RedNote.cart = sharedState.RedNote.cart.filter(item => !item.selected);
  // æ¸…ç©ºç¼“å­˜æ¶ˆæ¯
  sharedState.QQ.cacheMsg = [];
};

// åˆ é™¤é€‰ä¸­å•†å“
const deleteSelectedItems = () => {
  sharedState.RedNote.cart = sharedState.RedNote.cart.filter(item => !item.selected);
};
</script>

<style>
/* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
.rednote-postpage-bottom {
  display: flex;
  align-items: center;
  width: 100%;
  height: 45px;
  padding: 0px 10px;
  border-top: 1px solid #f6f6f6;
  gap: 3px;
}
.rednote-postpage-comment {
  display: flex;
  align-items: start;
  gap: 8px;
  /* margin-bottom: 25px; */
}
.rednote-postpage-content::-webkit-scrollbar {
  display: none !important;
}
.rednote-postpage-content {
  display: flex;
  flex: 1;
  flex-direction: column;
  width: 100%;
  overflow-y: auto;
  scrollbar-width: none !important;
  -ms-overflow-style: none !important;
}
.rednote-postpage-top {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 0 10px 10px;
  border-bottom: 1px solid #eaedf2;
}
.rednote-postpage {
  background-color: white;
  width: 100%;
  height: 100%;
  padding-top: 30px;
  display: flex;
  flex-direction: column;
}
.rednote-homepage-bottom-button {
  color: #939393;
  width: 3rem;
  font-size: 16px;
  text-align: center;
  cursor: pointer;
}
/* ä¿®æ”¹æ‰€æœ‰é¡µé¢çš„åº•éƒ¨å¯¼èˆªæ æ ·å¼ */
.rednote-homepage-bottom {
  width: 100%;
  height: 50px;
  display: flex;
  justify-content: space-evenly;
  align-items: center;
  background-color: #ffffff;
  border-top: 1px solid #e4e4e4;
  /* ç¡®ä¿åº•éƒ¨å¯¼èˆªæ å›ºå®šåœ¨åº•éƒ¨ */
  position: relative;
  margin-top: auto; /* åœ¨flexå¸ƒå±€ä¸­æ¨åˆ°æœ€åº•éƒ¨ */
}
.rednote-homepage-post-title {
  font-size: 16px;
  text-align: start;
  color: black !important;
}
.rednote-homepage-post-author {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-top: 10px;
}
.rednote-homepage-post-info {
  padding: 10px;
}
.post-img-blue {
  background-color: #ebe8f9;
}
.post-img-pink {
  background-color: #fbe7f0;
}
.post-img-green {
  background-color: #edefc8;
}
.post-img-purple {
  background-color: #d9c0ff;
}
.rednote-homepage-post-img {
  font-size: 20px;
  padding: 2.5rem 1.5rem;
  border-radius: 5px;
  text-align: center;
}
.rednote-homepage-post {
  width: 100%;
  margin-top: 5px;
  background-color: #ffffff;
  border-radius: 5px;
  height: fit-content;
  cursor: pointer;
  /* box-shadow: 2px 2px 2px rgba(15, 15, 15, 0.3); */
}
.rednote-homepage-content::-webkit-scrollbar {
  display: none !important;
}
.rednote-homepage-content {
  width: 100%;
  height: auto;
  flex: 1;
  display: grid;
  grid-template-columns: 50% 50%;
  gap: 5px;
  padding: 5px;
  overflow-y: auto;
  scrollbar-width: none !important;
  -ms-overflow-style: none !important;
}
.rednote-homepage {
  width: 100%;
  height: 100%;
  padding-top: 35px;
  display: flex;
  flex-direction: column;
  background-color: #f8fcfd;
}
.rednote-homepage-top {
  display: flex;
  font-size: 18px;
  align-items: center;
  justify-content: space-between;
  padding: 0px 15px 10px;
  /* gap: 30px; */
  border-bottom: 1px solid #e4e4e4;
}
.rednote-homepage {
  letter-spacing: 1px;
  line-height: 1.4;
}

/* å¸‚é›†é¡µé¢æ ·å¼ */
.rednote-market {
  width: 100%;
  height: 100%;
  padding-top: 35px;
  display: flex;
  flex-direction: column;
  background-color: #f8fcfd;
}

.rednote-market-top {
  display: flex;
  align-items: center;
  padding: 0px 15px 10px;
  border-bottom: 1px solid #e4e4e4;
  gap: 10px;
}

.market-search {
  flex: 1;
}

.search-box {
  display: flex;
  align-items: center;
  background: #f5f5f5;
  border-radius: 20px;
  padding: 8px 15px;
  gap: 8px;
}

.search-box input {
  border: none;
  background: transparent;
  outline: none;
  flex: 1;
  font-size: 14px;
}

.market-cart {
  cursor: pointer;
}

.market-categories {
  display: flex;
  padding: 10px 15px;
  gap: 15px;
  overflow-x: auto;
  border-bottom: 1px solid #e4e4e4;
}

.category-item {
  white-space: nowrap;
  padding: 5px 12px;
  border-radius: 15px;
  background: #f5f5f5;
  font-size: 14px;
  color: #646464;
  cursor: pointer;
}

.category-item.active {
  background: #ff2e63;
  color: white;
}

.market-content {
  flex: 1;
  overflow-y: auto;
}

.product-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  padding: 10px;
}

.product-card {
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  cursor: pointer;
}

.product-image {
  width: 100%;
  height: 150px;
  background-size: cover;
  background-position: center;
  background-color: #f5f5f5;
}

.product-info {
  padding: 10px;
}

.product-title {
  font-size: 14px;
  color: #333;
  margin-bottom: 5px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.product-price {
  font-size: 16px;
  color: #ff2e63;
  font-weight: bold;
  margin-bottom: 8px;
}

.product-seller {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-bottom: 5px;
}

.seller-avatar {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #e4e4e4;
}

.seller-name {
  font-size: 12px;
  color: #646464;
}

.product-stats {
  font-size: 12px;
  color: #646464;
}

/* å•†å“è¯¦æƒ…é¡µé¢æ ·å¼ */
.product-detail {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  z-index: 100;
  padding-top: 35px; /* æ·»åŠ è¿™ä¸ªï¼Œä¸ä¸»é¡µä¿æŒä¸€è‡´ */
}

.detail-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 15px;
  border-bottom: 1px solid #e4e4e4;
  background: white;
  /* ç§»é™¤æˆ–è°ƒæ•´ margin-topï¼Œå› ä¸ºå·²ç»æœ‰äº† padding-top */
}

.back-button,
.header-actions {
  width: 30px;
  cursor: pointer;
}

.header-title {
  flex: 1;
  text-align: center;
  font-weight: bold;
}
/* ç¡®ä¿é¡µé¢å®¹å™¨ä½¿ç”¨flexå¸ƒå±€ */
.product-detail,
.cart-page {
  display: flex;
  flex-direction: column;
}
.detail-content {
  flex: 1;
  overflow-y: auto;
}

.product-images {
  width: 100%;
  height: 300px;
}

.main-image {
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
}

.product-detail-info {
  padding: 15px;
}

.detail-price {
  font-size: 24px;
  color: #ff2e63;
  font-weight: bold;
  margin-bottom: 10px;
}

.detail-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 10px;
}

.detail-desc {
  font-size: 14px;
  color: #646464;
  line-height: 1.5;
  margin-bottom: 20px;
}

.seller-info {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 15px 0;
  border-top: 1px solid #e4e4e4;
  border-bottom: 1px solid #e4e4e4;
}

.seller-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #e4e4e4;
}

.seller-details {
  flex: 1;
}

.seller-name {
  font-weight: bold;
  margin-bottom: 2px;
}

.seller-rating {
  font-size: 12px;
  color: #646464;
}

.follow-btn {
  padding: 6px 12px;
  border: 1px solid #ff2e63;
  color: #ff2e63;
  border-radius: 15px;
  background: white;
  cursor: pointer;
  font-size: 12px;
}

.product-actions {
  display: flex;
  gap: 10px;
  padding: 15px 0;
  position: sticky;
  bottom: 0;
  background: white;
}

.cart-btn,
.buy-btn {
  flex: 1;
  padding: 10px;
  border-radius: 20px;
  font-weight: bold;
  cursor: pointer;
  font-size: 14px;
}

.cart-btn {
  border: 1px solid #ff2e63;
  background: white;
  color: #ff2e63;
}

.buy-btn {
  background: #ff2e63;
  color: white;
  border: none;
}

/* è´­ç‰©è½¦é¡µé¢æ ·å¼ */
.buy-selected-btn {
  padding: 8px 16px;
  background: #ff2e63;
  color: white;
  border: none;
  border-radius: 15px;
  cursor: pointer;
  font-size: 14px;
}
/* è´­ç‰©è½¦é¡µé¢æ ·å¼ */
.cart-page {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  z-index: 100;
  padding-top: 35px; /* æ·»åŠ è¿™ä¸ªï¼Œä¸ä¸»é¡µä¿æŒä¸€è‡´ */
  display: flex;
  flex-direction: column;
}
.cart-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 15px;
  border-bottom: 1px solid #e4e4e4;
  background: white;
  /* ç§»é™¤æˆ–è°ƒæ•´ margin-top */
}

.header-actions {
  color: #ff2e63;
  font-size: 14px;
  cursor: pointer;
}

.cart-content {
  flex: 1;
  overflow-y: auto;
  /* ç¡®ä¿å†…å®¹åŒºåŸŸå¯ä»¥æ­£å¸¸æ»šåŠ¨ */
}

.empty-cart {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  gap: 15px;
}

.empty-icon {
  font-size: 60px;
}

.empty-text {
  color: #646464;
}

.go-shopping {
  padding: 10px 30px;
  background: #ff2e63;
  color: white;
  border: none;
  border-radius: 20px;
  cursor: pointer;
}

.cart-item {
  display: flex;
  padding: 15px;
  border-bottom: 1px solid #e4e4e4;
  gap: 10px;
}

.item-select {
  display: flex;
  align-items: center;
}

.item-image {
  width: 80px;
  height: 80px;
  background-size: cover;
  background-position: center;
  border-radius: 8px;
}

.item-info {
  flex: 1;
}

.item-title {
  font-weight: bold;
  margin-bottom: 5px;
}

.item-price {
  color: #ff2e63;
  font-weight: bold;
  margin-bottom: 5px;
}

.item-seller {
  font-size: 12px;
  color: #646464;
  margin-bottom: 10px;
}

.item-actions {
  display: flex;
  justify-content: flex-end;
}

.delete-btn {
  padding: 4px 8px;
  border: 1px solid #e4e4e4;
  background: white;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  color: #ff2e63;
}

.cart-management {
  display: flex;
  justify-content: space-between;
  padding: 10px 15px;
  border-top: 1px solid #e4e4e4;
  background: white;
}

.select-all-btn,
.delete-selected-btn {
  padding: 8px 16px;
  border: 1px solid #ff2e63;
  background: white;
  color: #ff2e63;
  border-radius: 15px;
  cursor: pointer;
  font-size: 14px;
}

.delete-selected-btn {
  background: #ff2e63;
  color: white;
}

/* è¿‡æ¸¡åŠ¨ç”» */
.slide-fade-enter-active {
  transition: all 0.3s ease-out;
}

.slide-fade-leave-active {
  transition: all 0.3s cubic-bezier(1, 0.5, 0.8, 1);
}

.slide-fade-enter-from,
.slide-fade-leave-to {
  transform: translateX(20px);
  opacity: 0;
}
</style>
